<!DOCTYPE html>
<html lang="zh-CN">
  <style>
    * {box-sizing: border-box;}
    #text {font-size: 20px;color: #333;margin-top: 10px;}
    .xixi {width: 600px;height: 600px;background-color: white;border: 1px solid black;position: relative;border-width: 1px 0 0 1px;}
    .xixi div {width: 40px;height: 40px;border: 1px solid black;border-width: 0 1px 1px 0;position: absolute;font-size: 12px;color: #333;cursor: pointer;}
    .xixi div:hover{opacity: 0.8;}
  </style>
  <body>
    <div id='container' class='xixi'></div>
    <div id='text'></div>
  </body>
  <script src='../lib/AStarPath.js'></script>
  <script>
    const box = document.getElementById('container');
    const box_w = box_h = 600;
    const el_w = el_h = 40;
    const col = box_w / el_w;
    const row = box_h / el_h;
    const children = [];
    const obstacles = [];
    let startVector = 0;
    let endVector = 0;
    let start = [];
    let end = [];
    let clickCount = 0;

    // 生成格子
    for (let i = 0; i < row; i ++) {
      for (let j = 0; j < col; j ++) {
        const element = document.createElement('div');
        // 生成 0 - 7 随机数
        const randomNum = Math.random() * 834819 & 7;
        
        element.setAttribute('x', j);
        element.setAttribute('y', i);
        element.setAttribute('id', `${j}_${i}`);
        element.setAttribute('style', `left: ${j * el_w}px;top: ${i * el_h}px`);

        // 显示格子的矢量
        // element.textContent = `${j}, ${i}`;

        // 生成障碍物
        if (randomNum > 5) {
          obstacles.push([j, i]);
          element.style.background = '#666';
        }
        box.appendChild(element);

        element.addEventListener('click', clickFn);
      }
    }

    // const ASP = new AStarPath(options); 创建实例
    var ASP = AStarPath.create({
      screenSize: [col, row],
      obstacles,
      // isAstar: true,
      // isMustPath: true,
    })

    function pathFillColor (path) {
      console.log(path);
      if (path.length < 1) alert('此路不通，离终点十万八千里 -_-|||!');
      const rgba = ramdomRGBA();
      let count = 0;

      const loop = (p = path) => {
        const vector = p.shift();
        count += 1;

        if (!vector) return;
        const el = document.getElementById(`${vector[0]}_${vector[1]}`);
        el.style.background = rgba;
        setTimeout(() => loop(p), 100)
        document.getElementById('text').innerText = count;

        if (p.length < 1) {
          if (vector[0] !== endVector[0] || vector[1] !== endVector[1]) {
            setTimeout(() => alert('此路不通，要么翻山，要么打洞 -_-|||!'));
          }
          return;
        }
      }

      loop();
    }

    function branchsFillColor (branchs) {
      console.log(branchs);
      if (branchs.length < 1) alert('没有任何路径，哪怕原地踏步不会没有路径，你该吃药了 -_-|||!');
      const colorMap = new Map();
      const len = branchs.length;
      let count = 0;

      // 分支路径色彩映射
      for (let i = 0; i < len; i ++) {
        colorMap.set(i, ramdomRGBA());
      }

      const loop = (b = branchs) => {
        const bLen = b.length;
        let isComplete = true;
        count += 1;

        for (let j = 0;j < bLen; j ++) {
          const vector = b[j].shift();
          if (!vector) continue;

          const el = document.getElementById(`${vector[0]}_${vector[1]}`);
          el.style.background = colorMap.get(j);
        }
        document.getElementById('text').innerText = count;
        if (len > count) setTimeout(() => loop(b), 100);
      }

      loop();
    }

    function clickFn () {
      clickCount += 1;

      // 获取两个格子的间的最短路径
      if (clickCount === 1) {
        startVector = [Number(this.getAttribute('x')), Number(this.getAttribute('y'))];
      } else if (clickCount === 2) {
        clickCount = 0;
        endVector = [Number(this.getAttribute('x')), Number(this.getAttribute('y'))];

        // 可以直接获取path
        pathFillColor(ASP.getPath(startVector, endVector))
        // ASP.run({
        //   startVector,
        //   endVector,
        // }, ({ path, solved, branchs }) => {
        //   branchsFillColor(branchs);
        //   pathFillColor(path);
        // });
      }
    }

    const ramdomRGBA = () => {
      const num = 1 << 10;
      return `rgba(${(Math.random() * num) & 255}, ${(Math.random() * num) & 255}, ${(Math.random() * num) & 255}, 1)`;
    }
  </script>
</html>